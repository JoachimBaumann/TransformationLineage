name: Build and Package Changed Transformations

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build only changed transformations
        run: |
          set -e

          # Find changed transformation subdirectories
          changed_dirs=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^transformations/' | cut -d/ -f2 | sort -u)

          if [ -z "$changed_dirs" ]; then
            echo "No changed transformations detected."
            exit 0
          fi

          mkdir -p packagedTransformations

          for dir in $changed_dirs; do
            pom_path="transformations/$dir/pom.xml"
            if [ -f "$pom_path" ]; then
              echo "Building $dir"
              mvn -f "$pom_path" clean package

              echo "Copying resulting JARs from $dir"
              find "transformations/$dir/target" -type f -name "*.jar" -exec cp {} packagedTransformations/ \;
            else
              echo "No pom.xml found in $dir â€” skipping."
            fi
          done

      - name: List packaged JARs
        run: ls -lh packagedTransformations
